<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Print Kosten Calculator & Viewer (Ge√Øntegreerd)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        /* Globale Stijlen en Variabelen */
        :root {
            --color-primary: #007bff; /* Accentkleur (Helder Blauw) */
            --color-secondary: #6c757d; /* Secundaire kleur (Grijs) */
            --color-background: #1e1e1e; /* Hoofdscherm achtergrond (Donker Grijs) */
            --color-card: #282c34; /* Kaart/Veld achtergrond (Nog donkerder) */
            --color-text-light: #f8f9fa; /* Lichte tekst */
            --color-text-muted: #aaaaaa; /* Gedempte tekst */
            --color-border: #3c3c3c; /* Randkleur */
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-text-light);
            line-height: 1.6;
        }

        /* ------------------- NAVIGATIE BALK (HEADER) ------------------- */
        .main-header {
            background-color: var(--color-card);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--color-primary);
        }

        .main-header nav ul {
            list-style: none;
            display: flex;
        }

        .main-header nav ul li {
            margin-left: 20px;
        }

        .main-header nav ul li a {
            color: var(--color-text-light);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .main-header nav ul li a:hover {
            color: var(--color-primary);
        }

        /* ------------------- BREADCRUMBS ------------------- */
        .breadcrumbs {
            background-color: #242424;
            padding: 10px 30px;
            font-size: 0.9em;
            border-bottom: 1px solid var(--color-border);
        }

        .breadcrumbs a {
            color: var(--color-text-muted);
            text-decoration: none;
            transition: color 0.3s;
        }

        .breadcrumbs a:hover {
            color: var(--color-primary);
        }

        .breadcrumbs span {
            color: var(--color-text-light);
            font-weight: bold;
        }

        .breadcrumbs a:not(:last-child)::after {
            content: ' / ';
            margin: 0 5px;
            color: var(--color-text-muted);
        }

        /* ------------------- CONTAINER & LAYOUT ------------------- */
        .container {
            max-width: 1300px;
            margin: 30px auto;
            padding: 0 20px;
        }

        h1 {
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        .intro-text {
            color: var(--color-text-muted);
            margin-bottom: 20px;
        }

        hr {
            border: 0;
            border-top: 1px solid var(--color-border);
            margin: 20px 0;
        }

        .content-wrapper {
            display: flex;
            gap: 30px;
        }

        .viewer-section, .calculator-section {
            flex: 1;
            min-width: 450px;
        }

        /* ------------------- 3D VIEWER ------------------- */
        .model-viewer-container {
            background-color: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            height: 400px;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
        }

        #model-viewer {
            width: 100%;
            height: 100%;
        }

        #no-file-message, #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--color-text-muted);
            font-size: 1.2em;
            text-align: center;
        }

        .file-upload-area {
            text-align: center;
            padding: 20px;
            border: 2px dashed var(--color-border);
            border-radius: 8px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .file-upload-area.dragover {
            border-color: var(--color-primary);
            background-color: rgba(0, 123, 255, 0.1);
        }

        .file-info {
            background-color: var(--color-card);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .file-info h3 {
            margin-top: 0;
            color: var(--color-primary);
        }

        .file-info p {
            margin: 5px 0;
            font-size: 0.95em;
            color: var(--color-text-muted);
        }

        #viewer-stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--color-border);
        }

        /* ------------------- FORMULIER STIJLEN ------------------- */
        fieldset {
            border: 1px solid var(--color-border);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: var(--color-card);
        }

        legend {
            color: var(--color-primary);
            font-size: 1.1em;
            font-weight: bold;
            padding: 0 10px;
        }

        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: 500;
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: #333;
            color: var(--color-text-light);
            font-size: 1em;
        }

        .input-small {
            width: 100px; /* Kleinere breedte voor percentages/simpele inputs */
        }

        /* Knoppen */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            margin-top: 10px;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: #fff;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* Checkbox & Radio */
        .checkbox-group, .radio-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-group label, .radio-group label {
            display: inline;
            margin: 0 15px 0 5px;
        }

        .material-description, .note {
            font-size: 0.85em;
            color: var(--color-text-muted);
            margin-top: -5px;
            margin-bottom: 15px;
            padding-left: 5px;
        }

        /* ------------------- RESULTATEN SECTIE ------------------- */
        .results-box {
            background-color: #363636;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--color-primary);
        }

        .results-box h3 {
            margin-top: 0;
            color: var(--color-primary);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .result-label {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--color-text-muted);
            margin-bottom: 0;
        }

        .result-value {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--color-text-light);
            margin-top: 0;
        }

        .large-price {
            font-size: 3em;
            color: #28a745; /* Groen voor de eindprijs */
            line-height: 1;
            margin-bottom: 20px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px 0;
            border-top: 1px dashed var(--color-border);
            border-bottom: 1px dashed var(--color-border);
        }

        .detail-label {
            font-size: 0.9em;
            color: var(--color-text-muted);
        }

        .detail-value {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--color-text-light);
        }

        .calculation-summary {
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--color-text-muted);
        }

        .calculation-summary summary {
            cursor: pointer;
            color: var(--color-primary);
            margin-top: 10px;
        }

        #cost-calculation-details {
            padding: 10px;
            border-left: 2px solid var(--color-primary);
            background-color: #333333;
            margin-top: 10px;
        }

        /* ------------------- FOOTER ------------------- */
        .main-footer {
            background-color: var(--color-card);
            color: var(--color-text-muted);
            padding: 40px 30px 20px;
            border-top: 1px solid var(--color-border);
            margin-top: 50px;
        }

        .footer-content {
            max-width: 1300px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            gap: 30px;
            padding-bottom: 20px;
        }

        .footer-section {
            flex: 1;
            min-width: 200px;
        }

        .footer-section h3 {
            color: var(--color-primary);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .footer-section p {
            margin-bottom: 10px;
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section ul li a {
            color: var(--color-text-muted);
            text-decoration: none;
            line-height: 2;
            transition: color 0.3s;
        }

        .footer-section ul li a:hover {
            color: var(--color-primary);
        }

        .footer-bottom {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--color-border);
            font-size: 0.85em;
        }

        /* ------------------- RESPONSIVITEIT ------------------- */
        @media (max-width: 1000px) {
            .content-wrapper {
                flex-direction: column;
            }

            .viewer-section, .calculator-section {
                min-width: unset;
                width: 100%;
            }

            .footer-content {
                flex-direction: column;
            }
        }

        @media (max-width: 600px) {
            .main-header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 20px;
            }

            .main-header nav ul {
                margin-top: 10px;
            }

            .main-header nav ul li {
                margin-left: 0;
                margin-right: 15px;
            }
            
            .breadcrumbs {
                padding: 10px 20px;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .footer-section {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo">3D Print Pro</div>
        <nav>
            <ul>
                <li><a href="#calculator">Calculator</a></li>
                <li><a href="#viewer">3D Viewer</a></li>
                <li><a href="#settings">Instellingen</a></li>
                <li><a href="#contact">Contact</a></li>
            </ul>
        </nav>
    </header>

    <section class="breadcrumbs">
        <a href="/">Home</a> / <a href="#calculator">Services</a> / <span>Kosten Calculator</span>
    </section>

    <main class="container">
        <h1 id="calculator">3D Print Kosten & Tijd Schatter</h1>
        <p class="intro-text">Upload uw STL-bestand om direct het materiaalverbruik, de printtijd en de totale kosten te berekenen.</p>
        <hr>

        <div class="content-wrapper">
            
            <section class="viewer-section" id="viewer">
                <h2>Model Viewer & Analyse</h2>
                
                <div class="model-viewer-container">
                    <div id="model-viewer">
                        <div id="no-file-message">Upload een **STL-bestand** om de 3D-weergave te starten.</div>
                        <div id="loading" style="display: none;">Model wordt geladen...</div>
                    </div>
                </div>

                <div class="file-upload-area" id="drop-area">
                    <input type="file" id="file-input" accept=".stl" hidden>
                    <button id="upload-btn" class="btn btn-primary">STL Bestand Uploaden</button>
                    <p>Of sleep een bestand hierheen (Max 50MB)</p>
                </div>

                <div class="file-info">
                    <h3>Bestandsdetails</h3>
                    <p>Bestand: <span id="file-name">Geen bestand geselecteerd</span> (<span id="file-size">-</span>)</p>
                    <div id="viewer-stats" style="display: none;">
                        <p>Afmetingen: <span id="file-dimensions">-</span></p>
                        <p>Volume: <span id="file-volume">-</span></p>
                        <p>Driehoeken: <span id="triangle-count">0</span></p>
                        <p>Vertexen: <span id="vertex-count">0</span></p>
                    </div>
                    <button class="btn btn-secondary" onclick="toggleWireframe()">Wireframe Tonen</button>
                </div>
            </section>

            <section class="calculator-section">
                <h2>‚öôÔ∏è Instellingen & Berekening</h2>
                
                <fieldset class="input-group">
                    <legend>Materiaal & Printinstellingen</legend>
                    <label for="material">Materiaal type:</label>
                    <select id="material" onchange="updateMaterialInfo(); calculateCosts()">
                        <option value="pla">PLA</option>
                        <option value="pla_plus">PLA+</option>
                        <option value="petg">PETG</option>
                        <option value="abs">ABS</option>
                        <option value="tpu">TPU (Flexibel)</option>
                        <option value="custom">Aangepast</option>
                    </select>
                    <p class="material-description" id="material-description"></p>

                    <label for="infill-percentage">Infill Dichtheid (%):</label>
                    <input type="number" id="infill-percentage" value="20" min="0" max="100" oninput="calculateCosts()" class="input-small">
                </fieldset>
                
                <fieldset class="input-group" id="slicer-input-section">
                    <legend>Printdata Invoer (Optioneel)</legend>
                    <div class="checkbox-group">
                        <input type="checkbox" id="use-slicer-data" onchange="toggleSlicerInput()">
                        <label for="use-slicer-data">Gebruik Handmatige Slicer Data (overschrijft schattingen)</label>
                    </div>
                    
                    <div id="slicer-inputs" style="display: none;">
                        <label>Print Tijd (uur):</label>
                        <input type="number" id="slicer-time" value="0.0" step="0.1" oninput="calculateCosts()">

                        <div class="radio-group">
                            <input type="radio" id="input-weight" name="input-method" value="weight" checked onchange="toggleSlicerInputMethod()">
                            <label for="input-weight">Gewicht (gram)</label>
                            <input type="radio" id="input-length" name="input-method" value="length" onchange="toggleSlicerInputMethod()">
                            <label for="input-length">Filament Lengte (meter)</label>
                        </div>

                        <label for="slicer-weight" id="slicer-weight-label">Gewicht (gram):</label>
                        <input type="number" id="slicer-weight" value="0.0" step="0.1" oninput="calculateCosts()">
                        
                        <label for="slicer-length" id="slicer-length-label" style="display: none;">Lengte (meter):</label>
                        <input type="number" id="slicer-length" value="0.0" step="0.1" oninput="calculateCosts()" style="display: none;">
                        
                        <p class="note" id="estimation-note" style="display:none;">Waarden zijn automatisch geschat op basis van het STL-volume. Pas aan indien u slicer data heeft.</p>
                    </div>
                </fieldset>

                <fieldset class="input-group" id="settings">
                    <legend>Tarieven Instellen (‚Ç¨)</legend>
                    <label for="filament-price">Materiaal Prijs (‚Ç¨/kg):</label>
                    <input type="number" id="filament-price" value="25.00" step="0.01" oninput="calculateCosts()">
                    
                    <label for="machine-cost-per-hour">Machinekosten (‚Ç¨/uur):</label>
                    <input type="number" id="machine-cost-per-hour" value="5.00" step="0.01" oninput="calculateCosts()">
                    
                    <label for="setup-cost">Vaste Instelkosten/Afhandeling (‚Ç¨):</label>
                    <input type="number" id="setup-cost" value="2.50" step="0.01" oninput="calculateCosts()">
                </fieldset>

                <section class="results-box">
                    <h3>üí∏ Totale Kosten Schatting</h3>
                    <p class="result-label">Totaal Prijs:</p>
                    <p class="result-value large-price" id="total-price">‚Ç¨0.00</p>
                    
                    <div class="details-grid">
                        <div>
                            <p class="detail-label">Materiaal Verbruik:</p>
                            <p class="detail-value" id="print-weight">0.0 g</p>
                        </div>
                        <div>
                            <p class="detail-label">Geschatte Tijd:</p>
                            <p class="detail-value" id="print-time">0.0 uur</p>
                        </div>
                        <div>
                            <p class="detail-label">Materiaalkosten:</p>
                            <p class="detail-value" id="material-cost">‚Ç¨0.00</p>
                        </div>
                        <div>
                            <p class="detail-label">Vaste Kosten:</p>
                            <p class="detail-value" id="setup-cost-display">‚Ç¨2.50</p>
                        </div>
                    </div>
                    
                    <div class="calculation-summary">
                        <p id="calculation-source">Geen STL-bestand geladen. Prijs is vaste instelkosten.</p>
                        <details>
                            <summary>Bekijk gedetailleerde berekening</summary>
                            <div id="cost-calculation-details"></div>
                        </details>
                    </div>
                </section>
                
            </section>
        </div>
    </main>

    <footer class="main-footer" id="contact">
        <div class="footer-content">
            <div class="footer-section about">
                <h3>Over 3D Print Pro</h3>
                <p>Wij zijn gespecialiseerd in high-end 3D-printdiensten. Gebruik onze tool voor transparante en nauwkeurige prijsschattingen.</p>
            </div>
            <div class="footer-section links">
                <h3>Snelle Links</h3>
                <ul>
                    <li><a href="#calculator">Calculator</a></li>
                    <li><a href="#settings">Tarieven</a></li>
                    <li><a href="/faq">FAQ</a></li>
                    <li><a href="/voorwaarden">Voorwaarden</a></li>
                </ul>
            </div>
            <div class="footer-section contact-info">
                <h3>Contact</h3>
                <p>E-mail: info@3dprintpro.nl</p>
                <p>Telefoon: +31 123 456 789</p>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 3D Print Pro. Alle rechten voorbehouden.
        </div>
    </footer>

    <script>
        // --- CONSTANTEN & GLOBALE VARIABELEN ---

        // Uitgebreide materiaal dichtheden (g/cm¬≥)
        const materialDensities = {
            'pla': 1.24, 'pla_plus': 1.25, 'petg': 1.27, 'abs': 1.05,
            'asa': 1.07, 'tpu': 1.21, 'hips': 1.03, 'nylon': 1.14,
            'pc': 1.20, 'carbon': 1.30, 'wood': 1.20, 'metal': 1.30,
            'glow': 1.28, 'resin': 1.12, 'custom': 1.25
        };

        // Gram per meter voor 1.75mm filament
        const gramsPerMeter175 = {
            'pla': 2.98, 'pla_plus': 3.01, 'petg': 3.05, 'abs': 2.52,
            'asa': 2.57, 'tpu': 2.91, 'hips': 2.48, 'nylon': 2.74,
            'pc': 2.89, 'carbon': 3.13, 'wood': 2.89, 'metal': 3.13,
            'glow': 3.08, 'resin': 2.69, 'custom': 3.01
        };

        // Standaard materiaal prijzen (‚Ç¨/kg)
        const defaultMaterialPrices = {
            'pla': 25.00, 'pla_plus': 30.00, 'petg': 28.00, 'abs': 26.00,
            'asa': 35.00, 'tpu': 40.00, 'hips': 32.00, 'nylon': 45.00,
            'pc': 55.00, 'carbon': 65.00, 'wood': 35.00, 'metal': 50.00,
            'glow': 38.00, 'resin': 60.00, 'custom': 25.00
        };

        // Materiaal beschrijvingen
        const materialDescriptions = {
            'pla': "PLA: ‚Ç¨25/kg - Goed voor algemeen gebruik, makkelijk te printen",
            'pla_plus': "PLA+: ‚Ç¨30/kg - Sterker en duurzamer dan standaard PLA",
            'petg': "PETG: ‚Ç¨28/kg - Sterk, flexibel en hittebestendig",
            'abs': "ABS: ‚Ç¨26/kg - Hittebestendig maar moeilijker te printen",
            'tpu': "TPU: ‚Ç¨40/kg - Flexibel materiaal voor buigzame onderdelen",
            'custom': "Aangepast: Voer prijs en dichtheid handmatig in"
        };

        let stlGeometry = null;
        let scene, camera, renderer, controls, mesh;
        let currentWireframe = false;

        // --- KERN FUNCTIONALITEIT (STL PARSER & CALCULATOR) ---

        /**
         * Simpele Binary STL Parser.
         */
        class SimpleSTLParser {
            static parseBinarySTL(arrayBuffer) {
                const dataView = new DataView(arrayBuffer);
                if (arrayBuffer.byteLength < 84) throw new Error("Bestand te klein om een geldig binair STL-bestand te zijn.");

                const faceCount = dataView.getUint32(80, true);
                const expectedSize = 84 + (faceCount * 50);
                if (arrayBuffer.byteLength !== expectedSize) {
                    throw new Error("Ongeldig binair STL-formaat. Controleer of het een binair bestand is.");
                }

                const numFloats = faceCount * 3 * 3;
                const positions = new Float32Array(numFloats);
                const normals = new Float32Array(numFloats);

                let offset = 84;
                for (let i = 0; i < faceCount; i++) {
                    // Normal
                    const nx = dataView.getFloat32(offset, true); offset += 4;
                    const ny = dataView.getFloat32(offset, true); offset += 4;
                    const nz = dataView.getFloat32(offset, true); offset += 4;

                    for (let j = 0; j < 3; j++) {
                        // Vertices
                        const k = i * 9 + j * 3;
                        positions[k] = dataView.getFloat32(offset, true); offset += 4;
                        positions[k+1] = dataView.getFloat32(offset, true); offset += 4;
                        positions[k+2] = dataView.getFloat32(offset, true); offset += 4;

                        normals[k] = nx;
                        normals[k+1] = ny;
                        normals[k+2] = nz;
                    }
                    offset += 2; // Attribuut byte count
                }

                const geometry = new THREE.BufferGeometry();
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('normal', new THREE.BufferAttribute(normals, 3));
                geometry.computeBoundingBox();

                return geometry;
            }
        }

        /**
         * Berekent het volume van de STL geometrie via de tetra√´drische methode.
         * @param {THREE.BufferGeometry} geometry 
         * @returns {number} Volume in mm¬≥
         */
        function calculateSTLVolume(geometry) {
            if (!geometry || !geometry.attributes.position) return 0;

            const positions = geometry.attributes.position.array;
            let volume = 0;

            for (let i = 0; i < positions.length; i += 9) {
                const p1 = new THREE.Vector3(positions[i], positions[i+1], positions[i+2]);
                const p2 = new THREE.Vector3(positions[i+3], positions[i+4], positions[i+5]);
                const p3 = new THREE.Vector3(positions[i+6], positions[i+7], positions[i+8]);
                
                volume += p1.dot(p2.cross(p3)) / 6;
            }
            return Math.abs(volume);
        }

        /**
         * Hoofdfunctie om alle kosten te berekenen op basis van invoer en/of STL-volume.
         */
        function calculateCosts() {
            const selectedMaterial = document.getElementById('material').value;
            const infillPercentage = parseFloat(document.getElementById('infill-percentage').value) / 100;
            const filamentPricePerKg = parseFloat(document.getElementById('filament-price').value);
            const machineCostPerHour = parseFloat(document.getElementById('machine-cost-per-hour').value);
            const setupCost = parseFloat(document.getElementById('setup-cost').value);
            const useSlicerData = document.getElementById('use-slicer-data').checked;

            let printWeight_g = 0;
            let printTime_hours = 0;
            let sourceMessage = 'Voer instellingen in om te starten.';
            let materialCost = 0;
            let machineCost = 0;

            // 1. Bepaal Gewicht en Tijd
            if (useSlicerData) {
                const inputMethod = document.querySelector('input[name="input-method"]:checked').value;
                printTime_hours = parseFloat(document.getElementById('slicer-time').value) || 0;
                
                if (inputMethod === 'weight') {
                    printWeight_g = parseFloat(document.getElementById('slicer-weight').value) || 0;
                    sourceMessage = `Exacte gewicht (${printWeight_g.toFixed(1)}g) en tijd (${printTime_hours.toFixed(1)}u) ingevoerd.`;
                } else if (inputMethod === 'length') {
                    const length_m = parseFloat(document.getElementById('slicer-length').value) || 0;
                    const gramsPerMeter = gramsPerMeter175[selectedMaterial] || gramsPerMeter175['custom'];
                    printWeight_g = length_m * gramsPerMeter;
                    sourceMessage = `Exacte lengte (${length_m.toFixed(1)}m) en tijd (${printTime_hours.toFixed(1)}u) ingevoerd.`;
                }
            } else if (stlGeometry) {
                const totalVolume_mm3 = calculateSTLVolume(stlGeometry);
                const density_gcm3 = materialDensities[selectedMaterial] || materialDensities['custom'];
                
                // Schatting voor printvolume
                const effectiveVolume_mm3 = totalVolume_mm3 * (0.3 + (0.7 * infillPercentage));
                
                // Gewicht in gram
                printWeight_g = effectiveVolume_mm3 * density_gcm3 / 1000;
                
                // Ruwe schatting van de printtijd (factor 0.005 uur/gram)
                const timeFactor = 0.005; 
                printTime_hours = printWeight_g * timeFactor;
                
                sourceMessage = `Automatische schatting (Volume: ${(totalVolume_mm3 / 1000).toFixed(1)} cm¬≥ met ${infillPercentage * 100}% infill)`;
            } else {
                sourceMessage = 'Geen STL-bestand geladen. Prijs is vaste instelkosten.';
            }

            // 2. Bereken de kosten
            if (printWeight_g > 0 || printTime_hours > 0) {
                materialCost = (printWeight_g / 1000) * filamentPricePerKg;
                machineCost = printTime_hours * machineCostPerHour;
            }
            const totalCost = materialCost + machineCost + setupCost;

            // 3. Update de UI
            document.getElementById('total-price').textContent = `‚Ç¨${totalCost.toFixed(2)}`;
            document.getElementById('print-weight').textContent = `${printWeight_g.toFixed(1)} g`;
            document.getElementById('material-cost').textContent = `‚Ç¨${materialCost.toFixed(2)}`;
            document.getElementById('print-time').textContent = `${printTime_hours.toFixed(1)} uur`;
            document.getElementById('setup-cost-display').textContent = `‚Ç¨${setupCost.toFixed(2)}`;
            document.getElementById('machine-cost').textContent = `‚Ç¨${machineCost.toFixed(2)}`;
            document.getElementById('calculation-source').textContent = sourceMessage;
            
            // Gedetailleerde uitleg
            document.getElementById('cost-calculation-details').innerHTML = `
                Materiaalkosten: (‚Ç¨${filamentPricePerKg.toFixed(2)}/kg) * ${(printWeight_g/1000).toFixed(3)} kg = ‚Ç¨${materialCost.toFixed(2)}<br>
                Machinekosten: (${printTime_hours.toFixed(1)} uur) * (‚Ç¨${machineCostPerHour.toFixed(2)}/uur) = ‚Ç¨${machineCost.toFixed(2)}<br>
                Vaste kosten: ‚Ç¨${setupCost.toFixed(2)}<br>
                **Totaal: ‚Ç¨${totalCost.toFixed(2)}**
            `;
        }

        // --- 3D VIEWER LOGICA ---

        function initViewer() {
            const container = document.getElementById('model-viewer');
            const width = container.clientWidth;
            const height = container.clientHeight;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x282c34);

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 10000);
            camera.position.set(0, 0, 150);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xaaaaaa);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
            directionalLight.position.set(100, 200, 100);
            scene.add(directionalLight);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.addEventListener('change', render);

            const gridHelper = new THREE.GridHelper(100, 10, 0x444444, 0x888888);
            gridHelper.position.y = -0.1;
            scene.add(gridHelper);

            animate();
            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            const container = document.getElementById('model-viewer');
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
            render();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            render();
        }

        function render() {
            renderer.render(scene, camera);
        }

        function loadSTLModel(geometry) {
            if (mesh) {
                scene.remove(mesh);
                mesh.geometry.dispose();
            }

            stlGeometry = geometry;
            stlGeometry.center();
            const material = new THREE.MeshPhongMaterial({
                color: 0x007bff,
                specular: 0x111111,
                shininess: 30,
                wireframe: currentWireframe
            });
            mesh = new THREE.Mesh(stlGeometry, material);
            scene.add(mesh);

            updateModelInfo();
            resetView();
        }

        function resetView() {
            if (!stlGeometry) {
                camera.position.set(0, 0, 150);
                controls.target.set(0, 0, 0);
                return;
            }
            
            stlGeometry.computeBoundingSphere();
            const radius = stlGeometry.boundingSphere.radius;
            const center = stlGeometry.boundingSphere.center;

            const distance = radius * 2.5 / Math.tan(THREE.MathUtils.degToRad(camera.fov / 2));
            camera.position.set(center.x, center.y + radius * 0.5, center.z + distance * 0.8);
            controls.target.copy(center);
            camera.near = distance / 10;
            camera.far = distance * 10;
            camera.updateProjectionMatrix();
            controls.update();
        }

        function toggleWireframe() {
            currentWireframe = !currentWireframe;
            if (mesh && mesh.material) {
                mesh.material.wireframe = currentWireframe;
                mesh.material.needsUpdate = true;
            }
            document.querySelector('.btn-secondary').textContent = currentWireframe ? 'Schaduw Tonen' : 'Wireframe Tonen';
            render();
        }

        function updateModelInfo() {
            if (!stlGeometry) {
                document.getElementById('file-volume').textContent = '-';
                document.getElementById('file-dimensions').textContent = '-';
                document.getElementById('triangle-count').textContent = '0';
                document.getElementById('viewer-stats').style.display = 'none';
                return;
            }

            document.getElementById('viewer-stats').style.display = 'block';

            stlGeometry.computeBoundingBox();
            const size = new THREE.Vector3();
            stlGeometry.boundingBox.getSize(size);

            const volume_mm3 = calculateSTLVolume(stlGeometry);

            document.getElementById('file-volume').textContent = `${(volume_mm3 / 1000).toFixed(2)} cm¬≥`;
            document.getElementById('file-dimensions').textContent = `${size.x.toFixed(1)} x ${size.y.toFixed(1)} x ${size.z.toFixed(1)} mm`;
            document.getElementById('triangle-count').textContent = (stlGeometry.attributes.position.count / 3).toLocaleString('nl-NL');
            document.getElementById('vertex-count').textContent = stlGeometry.attributes.position.count.toLocaleString('nl-NL');

            const selectedMaterial = document.getElementById('material').value;
            const density_gcm3 = materialDensities[selectedMaterial] || materialDensities['custom'];
            const infillPercentage = parseFloat(document.getElementById('infill-percentage').value) / 100;
            const effectiveVolume_mm3 = volume_mm3 * (0.3 + (0.7 * infillPercentage));
            const estimatedWeight_g = effectiveVolume_mm3 * density_gcm3 / 1000;
            const estimatedTime_hours = estimatedWeight_g * 0.005;

            document.getElementById('slicer-weight').value = estimatedWeight_g.toFixed(1);
            document.getElementById('slicer-time').value = estimatedTime_hours.toFixed(1);
            document.getElementById('estimation-note').style.display = 'block';

            calculateCosts();
        }


        // --- UI / EVENT HANDLERS ---

        function updateMaterialInfo() {
            const selectedMaterial = document.getElementById('material').value;
            const descriptionEl = document.getElementById('material-description');
            const priceInputEl = document.getElementById('filament-price');

            const desc = materialDescriptions[selectedMaterial] || materialDescriptions['custom'];
            const price = defaultMaterialPrices[selectedMaterial] || defaultMaterialPrices['custom'];

            descriptionEl.textContent = desc;
            priceInputEl.value = price.toFixed(2);
            
            priceInputEl.disabled = (selectedMaterial !== 'custom');

            calculateCosts();
        }

        function toggleSlicerInput() {
            const useSlicerData = document.getElementById('use-slicer-data').checked;
            document.getElementById('slicer-inputs').style.display = useSlicerData ? 'block' : 'none';
            calculateCosts();
        }

        function toggleSlicerInputMethod() {
            const inputMethod = document.querySelector('input[name="input-method"]:checked').value;

            document.getElementById('slicer-weight-label').style.display = (inputMethod === 'weight') ? 'block' : 'none';
            document.getElementById('slicer-weight').style.display = (inputMethod === 'weight') ? 'block' : 'none';

            document.getElementById('slicer-length-label').style.display = (inputMethod === 'length') ? 'block' : 'none';
            document.getElementById('slicer-length').style.display = (inputMethod === 'length') ? 'block' : 'none';

            calculateCosts();
        }

        function showLoading(isLoading) {
            document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
        }

        function showMessage(type, message) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            if (type === 'error') alert(message);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleFile(file) {
            if (!file || !file.name.toLowerCase().endsWith('.stl')) {
                showMessage('error', 'Selecteer a.u.b. een geldig STL-bestand.');
                return;
            }

            showLoading(true);
            document.getElementById('no-file-message').style.display = 'none';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const geometry = SimpleSTLParser.parseBinarySTL(e.target.result);
                    
                    if (!geometry) throw new Error('Kon STL-bestand niet parsen. Controleer het bestandsformaat.');
                    
                    loadSTLModel(geometry);
                    showLoading(false);
                    showMessage('success', 'Bestand succesvol geladen! Berekening klaar.');
                    
                    document.getElementById('file-name').textContent = file.name;

                    document.getElementById('file-size').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
                    
                } catch (error) {
                    console.error('Fout bij het laden van STL:', error);
                    showLoading(false);
                    showMessage('error', 'Fout bij het parsen van STL: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- INITIALISATIE ---

        document.addEventListener('DOMContentLoaded', () => {
            initViewer(); 
            
            updateMaterialInfo();
            toggleSlicerInputMethod();
            calculateCosts();

            const fileInput = document.getElementById('file-input');
            const dropArea = document.getElementById('drop-area');

            document.getElementById('upload-btn').addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (event) => handleFile(event.target.files[0]));
            
            // Formulier/calculator inputs
            document.getElementById('infill-percentage').addEventListener('input', calculateCosts);
            document.getElementById('filament-price').addEventListener('input', calculateCosts);
            document.getElementById('machine-cost-per-hour').addEventListener('input', calculateCosts);
            document.getElementById('setup-cost').addEventListener('input', calculateCosts);
            document.getElementById('use-slicer-data').addEventListener('change', toggleSlicerInput);

            // Drop area handlers
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
            });

            dropArea.addEventListener('drop', (event) => {
                const dt = event.dataTransfer;
                handleFile(dt.files[0]);
            }, false);
        });
    </script>
</body>
</html>