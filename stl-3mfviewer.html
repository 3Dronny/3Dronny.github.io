<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>3D Model Viewer (STL & 3MF)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1e1e1e; color: white; font-family: sans-serif; }
        #viewer-container { width: 100vw; height: 100vh; position: relative; }
        #file-input { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 10; 
            padding: 10px; 
            background-color: #333; 
            border: 1px solid #555; 
            border-radius: 5px;
            color: white;
        }
        #placeholder { 
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
            font-size: 1.2em; color: #aaa; pointer-events: none;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/ThreeMFLoader.js"></script> 
</head>
<body>

    <div id="viewer-container">
        <div id="placeholder">Upload een STL of 3MF bestand om te starten.</div>
    </div>
    
    <input type="file" id="file-input" accept=".stl, .3mf">

    <script>
        // --- 1. SETUP VARIABELEN ---
        let scene, camera, renderer, controls;
        let object; 
        const container = document.getElementById('viewer-container');
        const fileInput = document.getElementById('file-input');
        const placeholder = document.getElementById('placeholder');
        
        // ** OPLOSSING:** WE VERWIJDEREN DE 'const ThreeMFLoader = THREE.ThreeMFLoader;' REGEL.
        // We gaan de constructor direct in de laadfunctie aanroepen.

        // Standaard materiaal voor STL-modellen
        const DEFAULT_MESH_MATERIAL = new THREE.MeshPhongMaterial({ 
            color: 0x007733, 
            emissive: 0x00331a,      
            specular: 0xffffff,      
            shininess: 30,                       
        });

        initViewer();
        
        // --- 2. INITIALISATIE (ongewijzigd) ---
        function initViewer() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1e1e1e); 

            // Camera
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 5000); 
            camera.position.set(100, 75, 150); 
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // Belichting
            scene.add(new THREE.AmbientLight(0xffffff, 0.5)); 
            const mainLight = new THREE.DirectionalLight(0xffffff, 1.5); 
            mainLight.position.set(100, 100, 100);
            scene.add(mainLight);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; 
            controls.dampingFactor = 0.15;
            controls.minDistance = 1;

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }
        
        function onWindowResize() {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // --- 3. LAAD FUNCTIE (Aangepast) ---
        fileInput.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            placeholder.style.display = 'none';

            const fileName = file.name.toLowerCase();
            const extension = fileName.substring(fileName.lastIndexOf('.') + 1);

            if (extension !== 'stl' && extension !== '3mf') {
                alert('Niet-ondersteund bestandstype. Selecteer een STL of 3MF.');
                return;
            }
            
            // Opruimen vorig model
            if (object) {
                scene.remove(object);
                object = null; 
            }

            try {
                const reader = new FileReader();
                const data = await new Promise((resolve, reject) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });

                let model;
                
                if (extension === 'stl') {
                    // STL Loader werkt altijd via THREE.STLLoader
                    const loader = new THREE.STLLoader();
                    const geometry = loader.parse(data);
                    model = new THREE.Mesh(geometry, DEFAULT_MESH_MATERIAL);
                    
                } else if (extension === '3mf') {
                    // ** FIX APPLICEREN:** De constructor heet correct 'THREE.ThreeMFLoader'
                    // We roepen hem nu direct aan in de if-else block.
                    if (typeof THREE.ThreeMFLoader === 'undefined') {
                        throw new Error("ThreeMFLoader is niet correct geladen.");
                    }
                    const loader = new THREE.ThreeMFLoader(); 
                    model = loader.parse(data); 
                }
                
                if (model) {
                    // Centreren en op de vloer zetten
                    const box = new THREE.Box3().setFromObject(model);
                    const center = new THREE.Vector3();
                    const size = new THREE.Vector3();
                    box.getCenter(center);
                    box.getSize(size);
                    
                    // Plaats het object zodat het gecentreerd en op de vloer (Y=0) staat.
                    model.position.set(-center.x, -box.min.y, -center.z);

                    scene.add(model);
                    object = model; 
                    
                    // Zoom de camera in op het model
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const distance = maxDim * 2; 
                    
                    controls.target.copy(new THREE.Vector3(model.position.x, center.y - box.min.y, model.position.z));
                    camera.position.set(model.position.x + distance, model.position.y + distance, model.position.z + distance);
                    controls.update();
                }

            } catch (error) {
                console.error(`‚ùå FOUT TIJDENS HET LADEN OF PARSEN VAN 3D-MODEL: ${error.name}: ${error.message}`);
                alert(`Fout bij het laden van ${extension}: ${error.message}.`); 
                placeholder.style.display = 'flex';
            }
        });

    </script>
</body>
</html>